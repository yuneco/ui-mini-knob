# Slider コンポーネント仕様

`Slider` は `Knob` のロジックを水平直線 UI に転用したコントロール型コンポーネント。`value` を親で制御し、ポインタ操作で `onChange` を発火する。リング表現・円形ガイドを水平線分へ置き換え、距離に応じたガイド拡張を行う。

## 外部 IF

### `<Slider />`

| Prop       | 型                        | デフォルト  | 説明                           |
| ---------- | ------------------------- | ----------- | ------------------------------ |
| `value`    | `number`                  | –           | 現在値（必須）。               |
| `min`      | `number`                  | `0`         | 下限値。                       |
| `max`      | `number`                  | `100`       | 上限値。                       |
| `step`     | `number`                  | `1`         | 値の分解能。丸め・目盛に反映。 |
| `onChange` | `(value: number) => void` | `undefined` | ポインタ操作時のコールバック。 |
| `disabled` | `boolean`                 | `false`     | UI とガイドを無効化。          |

### 内部構成

- `SliderUI`: DOM レンダリングとポインタイベントを担当。ノブ同様 `KnobPointerData` 相当のデータを算出するが、`dx/dy` を水平移動に合わせて変換し、`angle` ではなく線分上の比率を `getValueFromRelativePosition` に渡す。
- `SliderGuide`: ドラッグ中に表示される水平ガイド。距離計測、線分長制御、目盛描画を担う。

## 機能概要

- **水平ドラッグ**：ポインタ押下時に生成されるガイド線分上へポインタ座標を射影し、線分上の比率から値を決定。ガイド線分の長さに応じて `calculateTickStep` で算出した動的 `tickStep` へ丸め、`min/max` にクランプ。
- **差分表示**：ドラッグ開始値と現在値の区間を本体上の水平バーで `ACTIVE_COLOR` / `DIFF_COLOR_*` / `TRACK_COLOR` によって可視化。
- **値ラベル**：スライダー右端に現在値を `formatKnobValue` で整形して表示。ラベル位置は本体の右側に固定。
- **ドラッグガイド**：ポインタが押下されたときに `SliderGuide` を表示し、ポインタ距離に応じて線分を拡張。目盛とラベルを水平線で提供。
- **無効化**：`disabled` true のときポインタ操作とガイドを抑止し、カーソルを `not-allowed` に設定。

## UI 表示・ガイド目盛

### スライダー本体

- ベースラインは水平線（例: 幅 200px、高さ 4px）。中央ハンドルは円形もしくは矩形ノブで現在値位置を示す。
- 左右端に `min` / `max` の小ラベルを配置するか、本体下部に統合ラベルを表示する。
- 差分の描画は `Knob` のリングロジックを再利用し、アーク計算結果を線分比率へマッピングする。

### 値ラベル

- 本体右端に縦中央揃えで配置。固定幅コンテナに `formattedValue` を表示し、ドラッグ中も即時更新。

### ガイド目盛（水平線分）

1. **距離計測**
   - `distance = max(pointerDistanceVertical, 64)` とし、距離は本体の上下端からの直線オフセットとして扱う。
   - スライダー本体の中心が画面高さの 50% より下にある場合はガイドを上方向へ出す（距離は上端からのオフセット）。それ以外は下方向へ出す。
2. **基準情報取得**
   - ガイド展開時、スライダー本体の `boundingRect`（`left`, `right`, `top`, `bottom`）と `window.innerWidth`, `window.innerHeight` を取得。
   - ガイドを下に出す場合は「本体左下/右下からそれぞれ 64px 下がった点」と「画面左下/右下」を結ぶ台形が可動領域。上に出す場合は左上/右上から 64px 上がった点と画面上辺を結び同様に台形を作る。
3. **線分長の決定**
   - 取得した台形内で `distance` に応じた比率 `t = clamp(distance / maxDistance)` を求め、左右端を線形補間する。
   - これにより初期距離 64px の時点でもガイド線分の両端が台形方向へ少し広がり、本体より長くなる。
   - ガイド線分の左端=スライダーの min、右端=スライダーの max に対応する。
4. **位置補間**
   - スライダー中心 `sliderCenterY` を基準に、下向きは `lineY = sliderCenterY + distance`、上向きは `lineY = sliderCenterY - distance` とする。
   - 上下どちらの場合も `t` に応じて線分長・位置を補間し、カーソルが画面端へ近づくほどガイドが画面端へ近づく。必要に応じて画面外へ出ないようクランプする。
5. **値決定**
   - ポインタの `clientX` をガイド線分の左右端にクランプし、比率 `ratio = (x - lineLeft) / (lineRight - lineLeft)` から値を再計算する。
   - 同じ比率から算出した値を直近の `tickStep` にスナップすることで、ガイドの目盛単位と値変化が常に一致する。
6. **目盛生成**
   - `calculateTickStep` を線分長に対する実効半径へ置き換え、最小間隔 4px を維持しながら `tickStep`/`majorTickStep` を取得（値の丸めにも同じ結果を利用）。
   - `min`→`max` を等間隔に分割し、メイン目盛（長さ 12px, `MAJOR_TICK_COLOR`）とサブ目盛（8px, `#999`）を上下に描画。
   - ラベルはメイン目盛の真下に `formatTickLabel` を用いて配置。
7. **ポインタライン**
   - 現在値位置から垂直に線を下ろし、ガイド線分上の対応点をハイライトする。
   - 差分弧の表現は水平ガイド上で `startValue`→`value` の区間として描き、色は `Knob` と同一。

## 実装メモ

- `SliderUI` では `knobRef` と同様に DOMRect を管理し、`convertToPolar` の代わりに水平比率算出を行うヘルパを用意。`KnobPointerData` を再利用する場合は `angle` に代わって `ratio` を追加するか、`dx/dy` から `getValueFromRelativePosition` を導出できるようにする。
- ガイド線分は `position: fixed` の `<svg>` または `<canvas>` で描く。背景には半透明の帯を敷いて視認性を確保する。
- カーソルが画面外へ出る場合を考慮して `distance` と補間比率をクランプする。
- 既存の色定義やフォーマット関数は `Knob` の `defs/config.ts` と `logics/knob.ts` を再利用する。

この README を仕様ソースとして、`Slider` 実装やデザイン調整時の参照とする。
